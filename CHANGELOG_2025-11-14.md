# PDF XY Viewer - 変更履歴（2025-11-14）

## 実装した機能・改善

### 1. モーダルウィンドウの中央配置
- **変更**: `show_usage()` と `show_about()` モーダルをメインウィンドウの中央に表示
- **実装**: `center_window(window, width, height)` メソッドを追加
- **場所**: pdf_viewer.py:579-590

### 2. フォント改善
- **変更**: モーダル内のテキストフォントを Arial → **Meiryo UI** に変更
- **理由**: 日本語の可読性向上
- **対象**:
  - How to Useモーダルのテキストエリア
  - About Thisモーダルの全テキスト

### 3. How to Use モーダルのデザイン刷新
- **変更**: カードベースのモダンなレイアウトに変更
- **実装**: `create_usage_card(parent, title, items)` メソッドを追加
- **特徴**:
  - 各セクションがグレー背景のカードで区切られる
  - 絵文字アイコン付き（📄🖱⌨📐）
  - スクロール可能
  - 余白を大きく取りモダンな見た目
- **場所**: pdf_viewer.py:592-642

### 4. ズーム処理の高速化（3つの最適化）

#### 4-1. 画像キャッシュ機能
- **変更**: 画像ファイルを初回読み込み時にメモリにキャッシュ
- **効果**: ズーム時のディスクI/Oが0回に
- **実装**:
  - `self.cached_image` 変数を追加 (pdf_viewer.py:41)
  - 画像読み込み時にキャッシュ (pdf_viewer.py:294-298)
  - `display_page()` でキャッシュから取得 (pdf_viewer.py:327-333)

#### 4-2. 段階的レンダリング
- **変更**: 低品質プレビュー → 高品質レンダリングの2段階表示
- **実装**:
  - `display_page(quality='high'/'low')` パラメータ追加
  - 低品質: BILINEAR リサンプリング、PDF解像度70%
  - 高品質: LANCZOS リサンプリング、通常解像度
- **場所**: pdf_viewer.py:316-396

#### 4-3. レンダリング遅延（デバウンス）
- **変更**: 連続ズーム時は最後の1回だけ高品質レンダリング
- **実装**:
  - `self.render_timer` タイマー変数追加
  - 300ms後に高品質レンダリング実行
  - 連続ズーム時はタイマーをキャンセル＆再設定
- **場所**: pdf_viewer.py:557-570, 576-586

#### ズーム中の視覚的フィードバック
- カーソルを砂時計（watch）に変更
- ステータスバーにズーム倍率表示（例: "Zoom: 150%"）
- 高品質レンダリング完了後にカーソル復帰

### 5. グレースケール反転機能
- **ボタン**: ツールバーに `⚫⚪ Invert` ボタン追加
- **機能**: PDFと画像をグレースケール反転（白→黒、黒→白）
- **実装**:
  - `self.invert_colors` フラグ追加 (pdf_viewer.py:43)
  - `toggle_invert()` メソッド追加 (pdf_viewer.py:462-472)
  - `display_page()` 内で反転処理 (pdf_viewer.py:353-356, 392-395)
- **処理**: `img.convert('L')` でグレースケール化 → `ImageOps.invert()` で反転

### 6. マーカー座標のズーム対応
- **問題**: ズーム倍率変更時にマーカー位置がズレる
- **原因**: キャンバスの絶対ピクセル座標で保存していた
- **解決策**: 正規化座標（元画像の座標系）で保存
- **実装**:
  - `self.marker_positions` リストを追加 (pdf_viewer.py:138)
  - クリック時: `normalized_x = x / self.zoom` で正規化 (pdf_viewer.py:522-523)
  - 描画時: `x = normalized_x * self.zoom` で変換 (pdf_viewer.py:536-537)
  - `_draw_marker_at()` メソッドで再描画対応 (pdf_viewer.py:529-552)
- **効果**: 反転・ズーム変更時もマーカーが正しい位置に残る

## 技術的な詳細

### ズーム処理フロー
```
Ctrl+ホイール
  ↓
カーソル → 砂時計
  ↓
低品質プレビュー表示（即座）
  ↓
300ms 待機（追加ズームでタイマーリセット）
  ↓
高品質レンダリング
  ↓
カーソル → 通常
```

### マーカー座標管理
```
クリック時:
  絶対座標 (300, 400) → 正規化 (300/1.5=200, 400/1.5=266.67)

ズーム変更時:
  正規化座標 (200, 266.67) → 現在のズーム適用 (200*3.0=600, 266.67*3.0=800)
```

## ファイル構成

```
pdfXyViewer/
├── pdf_viewer.py           # メインアプリケーション（約780行）
├── hippo_019.png           # プレースホルダー画像
├── hippo_019_cir.ico       # アプリアイコン
├── requirements.txt        # 依存パッケージ
├── build.bat / build.sh    # ビルドスクリプト
└── README.md               # ドキュメント
```

## 既知の問題・未実装機能

特になし（現時点で安定動作）

## 次回作業時の確認事項

1. すべての機能が正常に動作しているか
2. ズーム・反転・マーカー機能の組み合わせテスト
3. パフォーマンスの体感確認

## 依存ライブラリ

```
PyMuPDF>=1.23.0
Pillow>=10.0.0
pyperclip>=1.8.2
tkinterdnd2>=0.3.0
```

## 実行方法

```bash
# 開発環境
python pdf_viewer.py

# ビルド（Windows）
build.bat
```

## 連絡先

- 作成者: 片岡 哲兵
- お問い合わせ: https://teppy.link/bbs
- ライセンス: MIT License
