# 次回セッション用 - クイックリファレンス

## 今回実装した主要機能（2025-11-14）

### ✅ 完了した改善
1. **モーダル中央配置** - メインウィンドウの中央に表示
2. **日本語フォント改善** - Meiryo UI採用
3. **モダンUIデザイン** - How to Useをカードベースに
4. **ズーム高速化** - 3つの最適化（キャッシュ・段階的レンダリング・遅延実行）
5. **グレースケール反転** - ⚫⚪ Invertボタン
6. **マーカー座標修正** - ズーム変更時のズレを解消

## 重要な変更箇所

### 主要メソッド
- `center_window()` - モーダル中央配置 (579行目)
- `create_usage_card()` - カード作成 (592行目)
- `display_page(quality)` - 段階的レンダリング (316行目)
- `toggle_invert()` - 反転切り替え (462行目)
- `draw_marker()` / `_draw_marker_at()` - 正規化座標対応 (515-552行目)

### 新しい変数
```python
self.cached_image = None           # 画像キャッシュ
self.render_timer = None           # レンダリングタイマー
self.invert_colors = False         # 反転フラグ
self.marker_positions = []         # 正規化座標リスト
```

## パフォーマンス改善の仕組み

```
【画像モード】
毎回ディスク読み込み → キャッシュから取得（大幅高速化）

【ズーム処理】
重い処理を毎回実行 → 低品質プレビュー + 遅延高品質レンダリング

【PDF処理】
常にフル解像度 → 低品質時は70%解像度 → スケールアップ
```

## もし問題が起きたら

### ズームが遅い
- `quality='low'` の解像度を調整（現在70%）
- タイマー遅延を調整（現在300ms）

### マーカーがズレる
- `draw_marker()` で正規化: `x / self.zoom`
- `_draw_marker_at()` で変換: `x * self.zoom`

### 反転が機能しない
- `ImageOps.invert()` の前に `convert('L')` でグレースケール化必須

## 次回の改善候補（未実装）

- [ ] キーボードショートカットで反転切り替え（例: Ctrl+I）
- [ ] マーカーの色・サイズ変更機能
- [ ] ズーム倍率の直接入力
- [ ] 最近開いたファイル履歴
- [ ] PDFの回転機能
- [ ] マーカーのエクスポート/インポート

## 問い合わせ時のテンプレート

```
以前のセッション（2025-11-14）で以下を実装済み：
- ズーム高速化（3つの最適化）
- グレースケール反転機能
- マーカー座標の正規化

現在の状況：
[ここに状況を記載]

やりたいこと：
[ここに要望を記載]
```

## ビルド前の確認

```bash
# 動作確認
python pdf_viewer.py

# 依存関係確認
pip list | grep -E "PyMuPDF|Pillow|pyperclip|tkinterdnd2"

# ビルド（Windows）
build.bat
```

## バージョン情報
- Python: 3.8以上
- 最終更新: 2025-11-14
- 主要ファイル: pdf_viewer.py (約780行)
